# 问题修复记录

## 概览
记录近期在狼人杀项目中的问题、原因与修复方案，便于回溯与后续迭代。

## 1. 夜间讨论 thought 泄露
- **问题**：狼人夜间讨论时，私密思考 `thought` 被队友看到。
- **原因**：消息自动广播包含原始 metadata。
- **修复**：关闭自动广播，新增 `_make_public_msg` 只保留可公开字段（speech/behavior），广播前剥离 `thought`。同时白天讨论、遗言等场景统一使用去隐私广播。
- **位置**：`backend/core/game_engine.py`

## 2. 狼人对队友身份不确定
- **问题**：反思阶段狼人写出“如果是狼人/身份未知”等表述。
- **原因**：上下文未提供已知队友信息，提示词缺少约束。
- **修复**：
  - `_format_impression_context` 为狼人提供队友名单与存活状态。
  - 反思提示增加狼人专属提醒，强调已知队友身份。
- **位置**：`backend/core/game_engine.py`

## 3. 女巫重复毒杀被狼人击杀的目标
- **问题**：女巫在同一夜间会对已被狼人刀死的玩家再次使用毒药，导致不符合规则的双重击杀。
- **原因**：毒药候选列表未排除当晚被狼人击杀的玩家。
- **修复**：毒药候选只包含其他存活玩家，排除狼刀目标；提示文案同步说明"可毒杀的存活玩家（不含被狼人击杀者）"。
- **位置**：`backend/models/roles.py`

## 4. 终端重复打印导致日志无法及时更新
- **问题**：终端中出现大量重复内容输出，且日志文件长时间不更新，导致无法实时跟踪游戏进程。某些时刻智能体陷入无限循环重复输出相同内容，游戏无法继续进行。
- **原因**：
  - `EchoAgent` 的 `reply()` 方法调用 `await self.print(msg)` 打印消息
  - `MsgHub.broadcast()` 触发所有智能体的 `observe()` 和可能的自动打印
  - 智能体默认启用提示信息打印导致消息被多次输出到终端
  - `EchoAgent.handle_interrupt()` 方法未正确返回 `Msg` 对象，导致程序卡住并抛出异常
- **修复**：
  - 禁用 `EchoAgent` 的 `print()` 调用（日志已完整记录所有内容）
  - 为所有 `ReActAgent` 添加 `print_hint_msg=False` 参数，禁用提示信息打印
  - 修复 `EchoAgent.handle_interrupt()` 返回空 `Msg` 对象，避免异常终止
  - 女巫行动日志分类细化为"女巫解药"和"女巫毒药"，避免视觉混淆
- **位置**：`backend/core/utils.py`, `backend/main.py`, `backend/core/game_logger.py`

## 5. 遗言机制不符合规则
- **问题**：
  1) 同一时间出局多人的情况下，仅最先出局的玩家能发表遗言，其他同时出局玩家的遗言被跳过。
  2) 遗言资格未按规则区分首夜与非首夜，导致夜间死亡的玩家（非首夜）也能发遗言。
- **修复**：
  - 新增 `_process_last_words`，按顺序为所有符合资格的出局玩家逐一广播遗言，避免遗漏。
  - 首夜限定：仅第一回合被狼人击杀或女巫毒杀的玩家可在白天环节发表遗言；后续夜间死亡不再有遗言；白天被投票出局的玩家仍可遗言。
- **位置**：`backend/core/game_engine.py`


